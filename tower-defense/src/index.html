<!doctype html>
<html>
  <head>
    <title>Tower Defense</title>
    <style type="text/css">
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #gameboard {
        width: 100%;
        background-color: rgb(133, 94, 58);
        position: relative;
      }

      .item {
        position: absolute;
        width: 25px;
        height: 25px;
      }
    </style>
  </head>
  <body>
    <div id="gameboard"></div>

    <script type="text/javascript">
      const TILE_SIZE = 25
    
      class Item {
        #key = ''
        _x = 0
        _y = 0
        
        #width = 0
        #height = 0
        _bottomX = 0
        _bottomY = 0
        
        constructor(x, y, width = TILE_SIZE, height = TILE_SIZE) {
          this.#key = rngesus.id()
          this._x = x
          this._y = y
          this.#width = width
          this.#height = height
          this._bottomX = x + width
          this._bottomY = y + height
        }

        key() {
          return this.#key
        }

        containsPoint(x, y) {
          return x >= this._x && x < this._bottomX && y >= this._y && y < this._bottomY
        }

        isInside(left, top, right, bottom) {
          console.log(`Seeing if ${ this._x },${ this._y} is inside ${ left },${ right },${ top },${ bottom }. ${this._x >= left},${this._x < right},${this._y >= top}, ${this._y < bottom}`)
          return this._x >= left && this._x < right && this._y >= top && this._y < bottom
        }

        getX() { return this._x }
        getY() { return this._y }

        colour() { return '#ffffff' }
        interact(player) { return false }
      }

      class Player extends Item {
        #destinationX = 0
        #destinationY = 0
        #destinationKey = ''

        #items = {
          'wood': 0
        }

        colour() { return '#800080' }

        giveItem(itemName) {
          items[itemName]++
          this.setDestination(0,0)
        }

        setDestination(x, y, key) {
          this.#destinationX = x
          this.#destinationY = y
          this.#destinationKey = key
        }

        update() {
          this._x += this.#getStep(this._x, this.#destinationX)
          this._y += this.#getStep(this._y, this.#destinationY)

          if (this._x === this.#destinationX && this._y === this.#destinationY) {
            // TODO:: Handle updating destination location if item location changes
            interactWithItem(this.#destinationKey)
          }
        }

        }

        #getStep(current, destination) {
          return current > destination ? TILE_SIZE * -1 : current < destination ? TILE_SIZE : 0
        }
      }

      class Tree extends Item {
        colour() { return '#008000' }
        interact(player) {
            player.giveItem('wood')
          removeItemByKey(this.key())
          return true
        }
      }

      class Random {
        #MAX_VALUE = 4294967295
        #ONE_PERCENT = this.#MAX_VALUE / 100

        #nextIndex = 0
        #source = new Uint32Array(10000)
        constructor() {
          this.#populate()
        }

        #populate() {
          this.#nextIndex = 0
          window.crypto.getRandomValues(this.#source)
        }

        next(upperLimit = 0) {
          let next = this.#source[this.#nextIndex]
          if (upperLimit > 0) {
            const ratio = this.#MAX_VALUE / upperLimit
            next /= ratio
          }
          
          this.#nextIndex++
          if (this.#nextIndex === this.#source.length) { this.#populate() }
          
          return next
        }

        position() {
          const next = this.next(boardLength - TILE_SIZE)
          return Math.floor(next / TILE_SIZE) * TILE_SIZE
        }

        id() {
          return this.next().toString(16).padStart(8, '0')
        }

        isSuccess(percentageRequired) {
          return this.next() >= (this.#ONE_PERCENT * percentageRequired)
        }
      }
    </script>

    <script type="text/javascript">
      const rngesus = new Random()
      const player = new Player(0, 0)
      
      const items = {}
      
      const board = document.querySelector('#gameboard')
      let boardLength = board.getBoundingClientRect().width
      board.style.height = boardLength.toString() + 'px'
      board.addEventListener('click', boardClickHandler)

      function boardClickHandler(event) {
        if (event.target.classList.contains('item')) {
          const key = event.target.getAttribute('key')
          interactWithItem(key)
        }
      }

      function interactWithItem(key) {
        const item = items[key]
        if (item == null) {
          // TODO:: Use mouse coordinates to work out what square was clicked on so we don't need to click on an item
          return false
        }

        if (item.containsPoint(player.getX(), player.getY())) {
          return item.interact(player)
        } else {
          player.setDestination(item.getX(), item.getY(), item.key())
        }
      }
      
      function maybeSpawnTree() {
        if (rngesus.isSuccess(95.5)) {
          addItem(new Tree(rngesus.position(), rngesus.position()))
        }
      }

      function getItemNode(key) {
        return document.querySelector('#item_' + key)
      }

      function renderItem(item) {
        requestAnimationFrame(() => {
          _renderItem(item)
        })
      }

      function _renderItem(item) {
        const box = document.createElement('div')
        box.classList.add('item')
        box.style.backgroundColor = item.colour()
        box.style.left = item.getX() + 'px'
        box.style.top = item.getY() + 'px'
        box.setAttribute('key', item.key())
        box.setAttribute('id', 'item_' + item.key())
        board.appendChild(box)
      }

      function unrenderItemByKey(key) {
        requestAnimationFrame(() => {
          _unrenderItemByKey(key)
        })
      }

      function _unrenderItemByKey(key) {
        const node = getItemNode(key)
        if (node != null) {
          board.removeChild(node)
        }
      }

      function addItem(item) {
        const key = item.key()
        if (getItemNode(key) == null) {
          items[key] = item
          renderItem(item)
        }
      }

      function removeItemByKey(key) {
        if (items[key] != null) {
          unrenderItemByKey(key)
          delete items[key]
        }
      }

      function loop() {
        maybeSpawnTree()
        requestAnimationFrame(() => {
          _unrenderItemByKey(player.key())
          player.update()
          _renderItem(player)
        })
        setTimeout(loop, 1000)
      }

      loop()
    </script>
  </body>
</html>